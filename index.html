<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MBPS Deal Packet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest + theme color -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981" />

  <!-- Icons (place PNGs in /icons) -->
  <link rel="apple-touch-icon" sizes="192x192" href="icons/mbps-deal-packet-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/mbps-deal-packet-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/mbps-deal-packet-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/mbps-deal-packet-512.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF + autoTable for professional PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">MBPS Deal Packet</h1>
        <p class="text-sm text-slate-400">
          Quick buyer-facing snapshot for your wholesale / creative deals.
        </p>
      </div>
      <div class="flex flex-col items-start md:items-end gap-1">
        <span class="inline-flex items-center rounded-full border border-emerald-500/60 px-3 py-1 text-xs font-semibold text-emerald-300 bg-emerald-500/10">
          Beta Â· v1
        </span>
        <p class="text-xs text-slate-400">
          MB Property Solutions Â· 984-710-6941 Â· mbpropertysolutionz@gmail.com
        </p>
        <p class="text-[0.65rem] text-slate-500">
          No seller info is ever included in this packet.
        </p>
      </div>
    </header>

    <!-- Logo upload section (for this packet / this device only) -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-3 md:p-4 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-xs font-semibold tracking-wide text-slate-200 uppercase">
          Packet Branding (Optional Logo)
        </h2>
        <span class="text-[0.65rem] text-slate-400">
          Logo is stored only in this browser and used in the PDF header.
        </span>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <div>
          <button id="logo-upload-trigger"
                  class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-950/80 hover:bg-slate-800/90">
            Upload Logo
          </button>
          <input id="logo-input" type="file" accept="image/*" class="hidden" />
        </div>
        <div id="logo-preview"
             class="flex items-center justify-center rounded-xl border border-dashed border-slate-700 bg-slate-950/80 px-3 py-2 min-h-[48px] w-full sm:w-48 text-[0.7rem] text-slate-500">
          No logo selected
        </div>
      </div>
    </section>

    <!-- Deal Summary -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <div class="flex-1">
          <label class="block text-xs font-semibold text-slate-400 mb-1">Property Address</label>
          <input id="deal-address" type="text" placeholder="123 Main St, City, ST ZIP"
                 class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 flex-none md:w-80">
          <div>
            <label class="block text-xs font-semibold text-slate-400 mb-1">ARV</label>
            <input id="deal-arv" type="number" inputmode="decimal" placeholder="250000"
                   class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-400 mb-1">Asking</label>
            <input id="deal-asking" type="number" inputmode="decimal" placeholder="175000"
                   class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-400 mb-1">Repairs (Est)</label>
            <input id="deal-repairs" type="number" inputmode="decimal" placeholder="50000"
                   class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div>
          <label class="block text-xs font-semibold text-slate-400 mb-1">Status</label>
          <select id="deal-status"
                  class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            <option value="Under Contract">Under Contract</option>
            <option value="Seeking Buyer">Seeking Buyer</option>
            <option value="Soft Hold">Soft Hold</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-400 mb-1">Close Date</label>
          <input id="deal-close-date" type="date"
                 class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-400 mb-1">Sq Ft</label>
          <input id="deal-sqft" type="number" inputmode="decimal" placeholder="1600"
                 class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-400 mb-1">Beds / Baths</label>
          <input id="deal-bedsbaths" type="text" placeholder="3 / 2"
                 class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
        </div>
      </div>
    </section>

    <!-- Deal Positioning: Exit Strategy + Buyer Profile -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Deal Positioning</h2>
        <span class="text-[0.7rem] text-slate-400">
          Exit strategy &amp; ideal buyer type for this deal.
        </span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Exit Strategies -->
        <fieldset class="space-y-2">
          <legend class="text-xs font-semibold text-slate-400 mb-1">Exit Strategy (you can pick multiple)</legend>
          <div class="grid grid-cols-2 gap-2 text-xs text-slate-200">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="Fix & Flip"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>Fix &amp; Flip</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="BRRRR"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>BRRRR</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="Long-Term Rental"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>Long-Term Rental</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="Mid-Term / Furnished"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>Mid-Term / Furnished</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="Wholetail"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>Wholetail</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="exit-strategy" value="Creative Finance"
                     class="rounded bg-slate-900 border-slate-600 text-emerald-500 focus:ring-emerald-500/70">
              <span>Creative Finance</span>
            </label>
          </div>
        </fieldset>

        <!-- Buyer Profile -->
        <div class="space-y-2">
          <label class="block text-xs font-semibold text-slate-400 mb-1">
            Target Buyer Profile
          </label>
          <select id="buyer-profile"
                  class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
            <option value="">Select profile</option>
            <option value="cash_flip">Cash Flipper â€“ 70% ARV minus repairs</option>
            <option value="brrrr_landlord">BRRRR Landlord â€“ cashflow + equity</option>
            <option value="turnkey_rental">Turnkey / Light Rehab Landlord</option>
            <option value="midterm_furnished">Mid-Term / Furnished Operator</option>
            <option value="creative_buyer">Creative Finance Buyer</option>
          </select>
          <p id="buyer-profile-desc" class="text-[0.7rem] text-slate-400 min-h-[2.2rem]">
            Pick a profile to show buyers who this is perfect for.
          </p>
        </div>
      </div>
    </section>

    <!-- Photos -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Photos</h2>
        <button id="photo-trigger"
                class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
          Browse Files
        </button>
      </div>

      <div id="photo-dropzone"
           class="border-2 border-dashed border-slate-700 rounded-2xl px-4 py-8 text-center cursor-pointer bg-slate-950/60 hover:border-emerald-500/70 hover:bg-slate-900/60 transition">
        <input id="photo-input" type="file" accept="image/*" multiple class="hidden" />
        <p class="text-sm text-slate-300 font-medium">Drag &amp; drop photos here</p>
        <p class="text-xs text-slate-500 mt-1">
          or click to upload from your device. Photos are not stored in templatesâ€”attach when sending.
        </p>
      </div>

      <div id="photo-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <!-- Thumbnails injected here -->
      </div>
    </section>

    <!-- Comps -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Comps</h2>
        <div class="flex items-center gap-2">
          <div class="text-xs text-slate-400">
            Avg $/sqft:
            <span id="avg-pps" class="font-semibold text-emerald-300">â€“</span>
          </div>
          <button id="add-comp-row"
                  class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
            + Add Comp
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-xs border-separate border-spacing-y-1">
          <thead class="text-[0.68rem] uppercase text-slate-400">
            <tr>
              <th class="text-left px-2 py-1">Address</th>
              <th class="text-left px-2 py-1">Dist (mi)</th>
              <th class="text-left px-2 py-1">Beds / Baths</th>
              <th class="text-left px-2 py-1">Sq Ft</th>
              <th class="text-left px-2 py-1">Sold Price</th>
              <th class="text-left px-2 py-1">DOM</th>
              <th class="text-left px-2 py-1">Notes</th>
              <th class="px-2 py-1"></th>
            </tr>
          </thead>
          <tbody id="comp-body">
            <!-- Rows injected -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Buyer-Facing Notes / Pitch -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Notes / Investor Pitch</h2>
      </div>
      <textarea id="deal-notes" rows="4"
                placeholder="Why this is a deal, exit strategies, area highlights, anything a serious buyer needs to know..."
                class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70"></textarea>
    </section>

    <!-- Internal Notes (never shown to buyer / PDF) -->
    <section class="bg-slate-900/60 border border-dashed border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">
          Internal Notes (Not in Buyer Packet)
        </h2>
        <span class="text-[0.7rem] text-slate-400">
          For seller conversations, VA notes, negotiation leverage, etc. Not exported.
        </span>
      </div>
      <textarea id="internal-notes" rows="4"
                placeholder="Seller situation, motivation, follow-up plan, do-not-share details..."
                class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70"></textarea>
    </section>

    <!-- Saved Packets / Templates -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">
          Saved Packets / Templates (Local Only)
        </h2>
        <span class="text-[0.7rem] text-slate-400">
          Saved in this browser only. Photos are not stored.
        </span>
      </div>

      <div class="flex flex-col md:flex-row gap-3 items-stretch">
        <div class="flex-1 space-y-2">
          <label class="block text-xs font-semibold text-slate-400 mb-1">Template Name</label>
          <input id="packet-name" type="text"
                 placeholder="e.g., Windsor Flip â€“ Hedge Fund Version"
                 class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/70">
          <div class="flex flex-wrap gap-2 mt-2">
            <button id="save-packet"
                    class="text-xs px-3 py-1 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400">
              Save as New
            </button>
            <button id="update-packet"
                    class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
              Update Selected
            </button>
          </div>
        </div>

        <div class="flex-1 space-y-2">
          <label class="block text-xs font-semibold text-slate-400 mb-1">Saved Packets</label>
          <div id="packet-list"
               class="max-h-40 overflow-y-auto rounded-xl border border-slate-800 bg-slate-950/80 text-xs divide-y divide-slate-800">
            <!-- Saved items injected here -->
          </div>
          <div class="flex flex-wrap gap-2 mt-2">
            <button id="load-packet"
                    class="text-xs px-3 py-1 rounded-full border border-emerald-500 text-emerald-300 bg-slate-900/80 hover:bg-slate-800/90">
              Load Selected
            </button>
            <button id="delete-packet"
                    class="text-xs px-3 py-1 rounded-full border border-red-500 text-red-300 bg-slate-900/80 hover:bg-red-500/10">
              Delete Selected
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary Output -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 md:p-5 space-y-3">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold tracking-wide text-slate-200 uppercase">Generated Summary</h2>
      </div>
      <div class="flex gap-2 mb-2">
        <button id="generate-summary"
                class="text-xs px-3 py-1 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400">
          Generate
        </button>
        <button id="copy-summary"
                class="text-xs px-3 py-1 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800/90">
          Copy
        </button>
        <button id="generate-pdf"
                class="text-xs px-3 py-1 rounded-full border border-emerald-500 bg-slate-900/80 text-emerald-300 hover:bg-slate-800/90">
          PDF
        </button>
      </div>
      <textarea id="summary-output" rows="6"
                class="w-full rounded-xl bg-slate-950/80 border border-slate-700 px-3 py-2 text-xs font-mono leading-snug focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                placeholder="Click Generate to build a buyer-ready summary you can paste into email or text."></textarea>
    </section>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    // ---- Helpers ----
    function formatDateMDY(dateStr) {
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      const [year, month, day] = parts;
      if (!year || !month || !day) return dateStr;
      return `${month}/${day}/${year}`;
    }

    // ---- Buyer profiles (buy-box) ----
    const BUY_BOX_PROFILES = {
      cash_flip: {
        name: 'Cash Flipper',
        desc: 'Typically wants ~70% of ARV minus repairs, prefers clear scope, fast close, solid equity spread.'
      },
      brrrr_landlord: {
        name: 'BRRRR Landlord',
        desc: 'Wants strong equity at refinance, rents that support DSCR, and value-add upside through rehab.'
      },
      turnkey_rental: {
        name: 'Turnkey / Light Rehab Landlord',
        desc: 'Prefers lighter renovations, stable areas, solid rent-to-price ratio, and minimal construction risk.'
      },
      midterm_furnished: {
        name: 'Mid-Term / Furnished Operator',
        desc: 'Targets hospital/college/employer proximity, good parking, safe area, and high MTR rent potential.'
      },
      creative_buyer: {
        name: 'Creative Finance Buyer',
        desc: 'Wants subto/seller finance terms: low money down, low monthly, long term, and strong cashflow spread.'
      }
    };

    // ---- Logo upload for this packet (keep aspect ratio) ----
    let logoDataUrl = null;
    let logoOrigWidth = null;
    let logoOrigHeight = null;

    const logoInput = document.getElementById('logo-input');
    const logoTrigger = document.getElementById('logo-upload-trigger');
    const logoPreview = document.getElementById('logo-preview');

    logoTrigger.addEventListener('click', () => logoInput.click());

    logoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (event) => {
        const dataUrl = event.target.result;

        const img = new Image();
        img.onload = () => {
          logoDataUrl = dataUrl;
          logoOrigWidth = img.width;
          logoOrigHeight = img.height;

          logoPreview.innerHTML = `
            <img src="${logoDataUrl}" alt="Logo preview"
                 class="max-h-10 w-auto object-contain rounded-lg bg-slate-900/80 p-1 border border-slate-700">
          `;
        };
        img.src = dataUrl;
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    });

    // ---- Buyer profile description handling ----
    const buyerProfileEl = document.getElementById('buyer-profile');
    const buyerProfileDescEl = document.getElementById('buyer-profile-desc');

    buyerProfileEl.addEventListener('change', () => {
      const profile = BUY_BOX_PROFILES[buyerProfileEl.value];
      if (!profile) {
        buyerProfileDescEl.textContent = 'Pick a profile to show buyers who this is perfect for.';
        return;
      }
      buyerProfileDescEl.textContent = `${profile.name}: ${profile.desc}`;
    });

    // ---- Photo handling (with baked-in rotation + delete) ----
    const dropzone = document.getElementById('photo-dropzone');
    const photoInput = document.getElementById('photo-input');
    const photoTrigger = document.getElementById('photo-trigger');
    const gallery = document.getElementById('photo-gallery');

    // photos: {id, dataUrl, caption}
    let photos = [];

    photoTrigger.addEventListener('click', () => photoInput.click());
    dropzone.addEventListener('click', () => photoInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-emerald-500', 'bg-slate-900/80');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-emerald-500', 'bg-slate-900/80');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-emerald-500', 'bg-slate-900/80');
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    photoInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
      e.target.value = '';
    });

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const id = crypto.randomUUID();
          const dataUrl = event.target.result;

          photos.push({
            id,
            dataUrl,
            caption: ''
          });

          renderPhotos();
        };
        reader.readAsDataURL(file);
      });
    }

    function renderPhotos() {
      gallery.innerHTML = '';
      photos.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'bg-slate-950/80 border border-slate-800 rounded-2xl overflow-hidden flex flex-col gap-2 relative';
        card.dataset.photoId = photo.id;

        card.innerHTML = `
          <div class="absolute top-1 right-1 flex gap-1">
            <button class="rotate-photo text-[0.65rem] px-2 py-0.5 rounded-full bg-slate-900/80 border border-slate-600 text-slate-200 hover:bg-slate-800">
              âŸ³ Rotate
            </button>
            <button class="remove-photo text-[0.65rem] px-2 py-0.5 rounded-full bg-slate-900/80 border border-red-500/60 text-red-300 hover:bg-red-500/10">
              ðŸ—‘ Remove
            </button>
          </div>
          <div class="aspect-video overflow-hidden">
            <img src="${photo.dataUrl}" alt="Property photo"
                 class="photo-img w-full h-full object-cover">
          </div>
          <div class="p-2 border-t border-slate-800">
            <textarea
              class="photo-caption w-full text-[0.7rem] bg-transparent border-0 focus:ring-0 text-slate-200 placeholder:text-slate-500 resize-none"
              rows="2"
              placeholder="Caption / notes (e.g., 'Kitchen â€“ needs full gut')">${photo.caption || ''}</textarea>
          </div>
        `;

        const captionEl = card.querySelector('.photo-caption');
        const rotateBtn = card.querySelector('.rotate-photo');
        const removeBtn = card.querySelector('.remove-photo');

        captionEl.addEventListener('input', () => {
          const p = photos.find(p => p.id === photo.id);
          if (p) p.caption = captionEl.value;
        });

        rotateBtn.addEventListener('click', () => rotatePhoto(photo.id));
        removeBtn.addEventListener('click', () => {
          photos = photos.filter(p => p.id !== photo.id);
          renderPhotos();
        });

        gallery.appendChild(card);
      });
    }

    // Rotate the actual image data (90Â° clockwise), so the PDF is correct without Adobe
    function rotatePhoto(photoId) {
      const photo = photos.find(p => p.id === photoId);
      if (!photo) return;

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = img.height;
        canvas.height = img.width;

        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(90 * Math.PI / 180);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);

        photo.dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        renderPhotos();
      };
      img.src = photo.dataUrl;
    }

    // initial render
    renderPhotos();

    // ---- Comps ----
    const compBody = document.getElementById('comp-body');
    const addCompRowBtn = document.getElementById('add-comp-row');
    const avgPpsSpan = document.getElementById('avg-pps');

    addCompRowBtn.addEventListener('click', addCompRow);

    function addCompRow(prefill = {}) {
      const row = document.createElement('tr');
      row.className = 'bg-slate-950/80';

      row.innerHTML = `
        <td class="px-2 py-1">
          <input type="text" class="w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="123 Comp St" value="${prefill.address || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="number" step="0.01" class="w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="0.4" value="${prefill.distance || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="text" class="w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="3 / 2" value="${prefill.bedsbaths || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="number" class="comp-sqft w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="1500" value="${prefill.sqft || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="number" class="comp-price w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="275000" value="${prefill.price || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="number" class="w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="7" value="${prefill.dom || ''}">
        </td>
        <td class="px-2 py-1">
          <input type="text" class="w-full bg-transparent border border-slate-800 rounded-lg px-1.5 py-1 text-[0.7rem]"
                 placeholder="Renovated / Dated / etc." value="${prefill.notes || ''}">
        </td>
        <td class="px-2 py-1 text-right">
          <button class="text-[0.65rem] text-red-400 hover:text-red-300">Remove</button>
        </td>
      `;

      row.querySelector('button').addEventListener('click', () => {
        row.remove();
        recomputeAvgPps();
      });

      row.querySelector('.comp-sqft').addEventListener('input', recomputeAvgPps);
      row.querySelector('.comp-price').addEventListener('input', recomputeAvgPps);

      compBody.appendChild(row);
      recomputeAvgPps();
    }

    function recomputeAvgPps() {
      const priceInputs = compBody.querySelectorAll('.comp-price');
      const sqftInputs = compBody.querySelectorAll('.comp-sqft');

      let totalPrice = 0;
      let totalSqft = 0;

      for (let i = 0; i < priceInputs.length; i++) {
        const price = parseFloat(priceInputs[i].value || '0');
        const sqft = parseFloat(sqftInputs[i].value || '0');
        if (price > 0 && sqft > 0) {
          totalPrice += price;
          totalSqft += sqft;
        }
      }

      if (totalPrice > 0 && totalSqft > 0) {
        const avg = totalPrice / totalSqft;
        avgPpsSpan.textContent = '$' + avg.toFixed(0) + '/sqft';
      } else {
        avgPpsSpan.textContent = 'â€“';
      }
    }

    // start with 3 empty comp rows
    addCompRow();
    addCompRow();
    addCompRow();

    // ---- Summary generation ----
    const generateSummaryBtn = document.getElementById('generate-summary');
    const copySummaryBtn = document.getElementById('copy-summary');
    const pdfBtn = document.getElementById('generate-pdf');
    const summaryOutput = document.getElementById('summary-output');

    generateSummaryBtn.addEventListener('click', () => {
      const address = document.getElementById('deal-address').value || 'TBD';
      const arv = document.getElementById('deal-arv').value;
      const asking = document.getElementById('deal-asking').value;
      const repairs = document.getElementById('deal-repairs').value;
      const status = document.getElementById('deal-status').value;
      const closeDateRaw = document.getElementById('deal-close-date').value;
      const closeDateDisplay = formatDateMDY(closeDateRaw);
      const sqft = document.getElementById('deal-sqft').value;
      const bedsbaths = document.getElementById('deal-bedsbaths').value;
      const notes = document.getElementById('deal-notes').value;

      const arvNum = parseFloat(arv || '0');
      const askingNum = parseFloat(asking || '0');
      const repairsNum = parseFloat(repairs || '0');

      let allIn = '';
      let spread = '';
      if (arvNum && askingNum && repairsNum) {
        const allInNum = askingNum + repairsNum;
        const spreadNum = arvNum - allInNum;
        allIn = `Buyer all-in (price + repairs): ~$${allInNum.toLocaleString()}`;
        spread = `Estimated equity at ARV: ~$${spreadNum.toLocaleString()}`;
      }

      // Exit strategies
      const exitStrategies = Array.from(
        document.querySelectorAll('input[name="exit-strategy"]:checked')
      ).map(el => el.value);

      // Buyer profile
      const buyerProfileId = buyerProfileEl.value;
      const buyerProfile = BUY_BOX_PROFILES[buyerProfileId];

      // build comps summary
      const rows = compBody.querySelectorAll('tr');
      const compLines = [];
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (!inputs.length) return;
        const [addr, dist, bb, csqft, price, dom, cnotes] = inputs;
        if (addr.value || price.value) {
          compLines.push(
            `- ${addr.value || 'Comp'} | ${bb.value || 'â€“'} | ${csqft.value || 'â€“'} sqft | $${(price.value || '0')} | DOM: ${dom.value || 'â€“'} | ${cnotes.value || ''}`
          );
        }
      });

      const pps = avgPpsSpan.textContent || 'â€“';

      const summary = [
        `ðŸ“ **Property**`,
        `${address}`,
        bedsbaths || sqft ? `${bedsbaths ? bedsbaths + ' | ' : ''}${sqft ? sqft + ' sqft' : ''}` : '',
        '',
        `ðŸ’° **Numbers**`,
        arv ? `- ARV: $${Number(arv).toLocaleString()}` : '',
        asking ? `- Asking: $${Number(asking).toLocaleString()}` : '',
        repairs ? `- Estimated Repairs: $${Number(repairs).toLocaleString()}` : '',
        allIn ? `- ${allIn}` : '',
        spread ? `- ${spread}` : '',
        '',
        `ðŸŽ¯ **Exit Strategy**`,
        exitStrategies.length ? exitStrategies.map(s => `- ${s}`).join('\n') : '- Not set yet.',
        '',
        `ðŸ‘¤ **Target Buyer Profile**`,
        buyerProfile
          ? `- ${buyerProfile.name}: ${buyerProfile.desc}`
          : '- Not selected.',
        '',
        `ðŸ“… **Status**`,
        `- ${status}${closeDateDisplay ? ` | Close: ${closeDateDisplay}` : ''}`,
        '',
        `ðŸ“Š **Comps (manual)**`,
        `Avg price per sqft (set): ${pps}`,
        compLines.length ? compLines.join('\n') : '- Comps not entered yet.',
        '',
        `ðŸ“ **Notes / Pitch**`,
        notes || '- (Add your buyer-facing pitch here.)',
        '',
        `ðŸ”Ž Photos`,
        photos.length
          ? '- Photos embedded in attached PDF.'
          : '- Photos not added yet.'
      ].filter(Boolean).join('\n');

      summaryOutput.value = summary;
    });

    copySummaryBtn.addEventListener('click', async () => {
      if (!summaryOutput.value.trim()) {
        generateSummaryBtn.click();
      }
      try {
        await navigator.clipboard.writeText(summaryOutput.value);
        copySummaryBtn.textContent = 'Copied!';
        setTimeout(() => { copySummaryBtn.textContent = 'Copy'; }, 1200);
      } catch (err) {
        alert('Copy failed, please select and copy manually.');
      }
    });

    // ---- PDF generation with branding + exit strategies + buyer profile + multi-photo grid ----
    pdfBtn.addEventListener('click', () => {
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const leftMargin = 40;
      const rightMargin = 40;
      const bottomMargin = 40;

      // Brand bar background
      doc.setFillColor(16, 185, 129);
      doc.rect(0, 0, pageWidth, 60, 'F');

      const hasLogo = !!logoDataUrl;
      if (hasLogo) {
        try {
          // Keep aspect ratio, fit into max box
          const maxW = 70;
          const maxH = 40;
          let logoW = maxW;
          let logoH = maxH;

          if (logoOrigWidth && logoOrigHeight) {
            const ratio = logoOrigWidth / logoOrigHeight;
            if (ratio >= 1) {
              // wider than tall
              logoW = maxW;
              logoH = maxW / ratio;
              if (logoH > maxH) {
                const scale = maxH / logoH;
                logoH = maxH;
                logoW = logoW * scale;
              }
            } else {
              // taller than wide
              logoH = maxH;
              logoW = maxH * ratio;
              if (logoW > maxW) {
                const scale = maxW / logoW;
                logoW = maxW;
                logoH = logoH * scale;
              }
            }
          }

          const logoX = 20;
          const logoY = (60 - logoH) / 2;

          doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoW, logoH);
        } catch (e) {
          console.error('Failed to add logo to PDF', e);
        }
      }

      // Brand text
      doc.setTextColor(255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);
      const brandTextX = hasLogo ? 100 : 40;
      doc.text('MB Property Solutions', brandTextX, 24);

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Wholesale Â· Creative Finance Â· Investment Deals', brandTextX, 38);

      // Right-aligned contact info
      doc.setFontSize(9);
      const contactPhone = '984-710-6941';
      const contactEmail = 'mbpropertysolutionz@gmail.com';
      doc.text(contactPhone, pageWidth - 40, 20, { align: 'right' });
      doc.text(contactEmail, pageWidth - 40, 32, { align: 'right' });

      // Body text color
      doc.setTextColor(0);
      let y = 80;

      const address = document.getElementById('deal-address').value || 'TBD';
      const arv = document.getElementById('deal-arv').value;
      const asking = document.getElementById('deal-asking').value;
      const repairs = document.getElementById('deal-repairs').value;
      const status = document.getElementById('deal-status').value;
      const closeDateRaw = document.getElementById('deal-close-date').value;
      const closeDateDisplay = formatDateMDY(closeDateRaw);
      const sqft = document.getElementById('deal-sqft').value;
      const bedsbaths = document.getElementById('deal-bedsbaths').value;
      const notes = document.getElementById('deal-notes').value;

      const arvNum = parseFloat(arv || '0');
      const askingNum = parseFloat(asking || '0');
      const repairsNum = parseFloat(repairs || '0');

      let allIn = null;
      let spread = null;
      if (arvNum && askingNum && repairsNum) {
        allIn = askingNum + repairsNum;
        spread = arvNum - allIn;
      }

      // Exit strategies & buyer profile
      const exitStrategies = Array.from(
        document.querySelectorAll('input[name="exit-strategy"]:checked')
      ).map(el => el.value);
      const buyerProfileId = buyerProfileEl.value;
      const buyerProfile = BUY_BOX_PROFILES[buyerProfileId];

      // Deal Overview
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text('Deal Overview', leftMargin, y);
      y += 18;

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.text(`Property: ${address}`, leftMargin, y);
      y += 14;
      if (bedsbaths || sqft) {
        doc.text(
          `${bedsbaths ? bedsbaths + ' | ' : ''}${sqft ? sqft + ' sqft' : ''}`,
          leftMargin,
          y
        );
        y += 14;
      }
      doc.text(
        `Status: ${status}${closeDateDisplay ? ' | Close: ' + closeDateDisplay : ''}`,
        leftMargin,
        y
      );
      y += 24;

      // Key Numbers
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Key Numbers', leftMargin, y);
      y += 14;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      if (arv) {
        doc.text(`ARV: $${Number(arv).toLocaleString()}`, leftMargin, y);
        y += 14;
      }
      if (asking) {
        doc.text(`Asking: $${Number(asking).toLocaleString()}`, leftMargin, y);
        y += 14;
      }
      if (repairs) {
        doc.text(`Estimated Repairs: $${Number(repairs).toLocaleString()}`, leftMargin, y);
        y += 14;
      }
      if (allIn !== null && spread !== null) {
        doc.text(`Buyer all-in (price + repairs): ~$${allIn.toLocaleString()}`, leftMargin, y);
        y += 14;
        doc.text(`Estimated equity at ARV: ~$${spread.toLocaleString()}`, leftMargin, y);
        y += 18;
      } else {
        y += 4;
      }

      // Exit Strategy section
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Exit Strategy', leftMargin, y);
      y += 14;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      if (exitStrategies.length) {
        exitStrategies.forEach(es => {
          doc.text(`â€¢ ${es}`, leftMargin, y);
          y += 12;
        });
      } else {
        doc.text('â€¢ Not specified', leftMargin, y);
        y += 12;
      }
      y += 6;

      // Buyer Profile section
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Target Buyer Profile', leftMargin, y);
      y += 14;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      if (buyerProfile) {
        const bpText = `${buyerProfile.name}: ${buyerProfile.desc}`;
        const bpLines = doc.splitTextToSize(bpText, pageWidth - leftMargin - rightMargin);
        doc.text(bpLines, leftMargin, y);
        y += bpLines.length * 12 + 10;
      } else {
        doc.text('Not selected', leftMargin, y);
        y += 16;
      }

      // Comps table
      const compRows = [];
      compBody.querySelectorAll('tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (!inputs.length) return;
        const [addr, dist, bb, csqft, price, dom, cnotes] = inputs;
        if (!addr.value && !price.value) return;
        compRows.push([
          addr.value || '',
          dist.value || '',
          bb.value || '',
          csqft.value || '',
          price.value || '',
          dom.value || '',
          cnotes.value || ''
        ]);
      });

      if (compRows.length) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        if (y > pageHeight - 200) {
          doc.addPage();
          y = 60;
        }
        doc.text('Sales Comparables', leftMargin, y);
        y += 10;

        doc.autoTable({
          startY: y + 4,
          head: [['Address', 'Dist (mi)', 'Beds/Baths', 'Sq Ft', 'Sold Price', 'DOM', 'Notes']],
          body: compRows,
          styles: { fontSize: 8, cellPadding: 3 },
          headStyles: { fillColor: [16, 185, 129], textColor: 255 },
          margin: { left: leftMargin, right: rightMargin }
        });
        y = doc.lastAutoTable.finalY + 20;
      }

      // Notes / Pitch (buyer-facing)
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      if (y > pageHeight - 200) {
        doc.addPage();
        y = 60;
      }
      doc.text('Notes / Investor Pitch', leftMargin, y);
      y += 14;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      const notesText = notes || '(Add your buyer-facing pitch here: condition, scope of work, exit strategies, area highlights, etc.)';
      const splitNotes = doc.splitTextToSize(notesText, pageWidth - leftMargin - rightMargin);
      doc.text(splitNotes, leftMargin, y);
      y += splitNotes.length * 12 + 16;

      // Photos with captions â€” multiple per page, using baked-in rotation
      if (photos.length) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        if (y > pageHeight - 200) {
          doc.addPage();
          y = 60;
        }
        doc.text('Photos', leftMargin, y);
        y += 16;

        const maxWidth = pageWidth - leftMargin - rightMargin;
        const photosPerRow = 2;
        const gapX = 16;
        const gapY = 24;
        const photoWidth = (maxWidth - gapX * (photosPerRow - 1)) / photosPerRow;
        const photoHeight = photoWidth * 0.6;

        let colIndex = 0;
        let rowBottomY = y + photoHeight + 10;

        photos.forEach((photo) => {
          // If starting a new row and not enough space, new page
          if (colIndex === 0 && y + photoHeight + 40 > pageHeight - bottomMargin) {
            doc.addPage();
            y = 60;
            rowBottomY = y + photoHeight + 10;
          }

          const x = leftMargin + colIndex * (photoWidth + gapX);

          // Add image (no extra rotation here; already baked into dataUrl)
          try {
            doc.addImage(
              photo.dataUrl,
              'JPEG',
              x,
              y,
              photoWidth,
              photoHeight,
              undefined,
              'FAST'
            );
          } catch (e) {
            try {
              doc.addImage(
                photo.dataUrl,
                'PNG',
                x,
                y,
                photoWidth,
                photoHeight,
                undefined,
                'FAST'
              );
            } catch (err) {
              console.error('Error adding photo to PDF', err);
            }
          }

          let captionBottom = y + photoHeight + 10;
          if (photo.caption && photo.caption.trim()) {
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(9);
            const capLines = doc.splitTextToSize(photo.caption.trim(), photoWidth);
            doc.text(capLines, x, y + photoHeight + 10);
            captionBottom = y + photoHeight + 10 + capLines.length * 11 + 4;
          }

          rowBottomY = Math.max(rowBottomY, captionBottom);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);

          colIndex++;
          if (colIndex === photosPerRow) {
            // Move to next row
            colIndex = 0;
            y = rowBottomY + gapY;
            rowBottomY = y + photoHeight + 10;
          }
        });

        // If last row wasn't closed, bump y to below photos
        if (colIndex !== 0) {
          y = rowBottomY + gapY;
        }
      }

      // Footer (no internal notes, no seller info)
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text('MB Property Solutions Â· Confidential Buyer Packet', leftMargin, pageHeight - 26);

      const safeAddress = address.replace(/[^a-z0-9]/gi, '_').slice(0, 40) || 'mbps_deal_packet';
      doc.save(`${safeAddress}.pdf`);
    });

    // ---- Saved Packets / Templates (localStorage) ----
    const PACKET_STORAGE_KEY = 'mbpsDealPacketsV1';
    let savedPackets = [];
    let selectedPacketId = null;

    const packetNameEl = document.getElementById('packet-name');
    const packetListEl = document.getElementById('packet-list');
    const savePacketBtn = document.getElementById('save-packet');
    const updatePacketBtn = document.getElementById('update-packet');
    const loadPacketBtn = document.getElementById('load-packet');
    const deletePacketBtn = document.getElementById('delete-packet');

    function loadSavedPackets() {
      try {
        const raw = localStorage.getItem(PACKET_STORAGE_KEY);
        savedPackets = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('Failed to load saved packets', e);
        savedPackets = [];
      }
      renderSavedPackets();
    }

    function persistSavedPackets() {
      localStorage.setItem(PACKET_STORAGE_KEY, JSON.stringify(savedPackets));
    }

    function renderSavedPackets() {
      packetListEl.innerHTML = '';
      if (!savedPackets.length) {
        packetListEl.innerHTML =
          '<div class="px-3 py-2 text-[0.7rem] text-slate-500">No saved packets yet.</div>';
        return;
      }

      savedPackets
        .slice()
        .sort((a, b) => b.updatedAt - a.updatedAt)
        .forEach(packet => {
          const row = document.createElement('button');
          row.type = 'button';
          row.className =
            'w-full text-left px-3 py-2 flex items-center justify-between gap-2 hover:bg-slate-800/80';
          if (packet.id === selectedPacketId) {
            row.classList.add('bg-slate-800');
          }
          row.dataset.id = packet.id;
          const updatedDate = new Date(packet.updatedAt);
          row.innerHTML = `
            <div class="flex-1 min-w-0">
              <div class="truncate text-[0.75rem] text-slate-100 font-medium">${packet.name}</div>
              <div class="text-[0.65rem] text-slate-500 truncate">
                ${packet.address || 'No address'} Â· ${packet.buyerProfileName || 'No profile set'}
              </div>
            </div>
            <div class="text-[0.65rem] text-slate-500 whitespace-nowrap pl-2">
              ${updatedDate.toLocaleDateString('en-US')}
            </div>
          `;
          row.addEventListener('click', () => {
            selectedPacketId = packet.id;
            packetNameEl.value = packet.name || '';
            renderSavedPackets();
          });
          packetListEl.appendChild(row);
        });
    }

    function collectPacketState() {
      const address = document.getElementById('deal-address').value || '';
      const arv = document.getElementById('deal-arv').value || '';
      const asking = document.getElementById('deal-asking').value || '';
      const repairs = document.getElementById('deal-repairs').value || '';
      const status = document.getElementById('deal-status').value || '';
      const closeDate = document.getElementById('deal-close-date').value || '';
      const sqft = document.getElementById('deal-sqft').value || '';
      const bedsbaths = document.getElementById('deal-bedsbaths').value || '';
      const notes = document.getElementById('deal-notes').value || '';
      const internalNotes = document.getElementById('internal-notes').value || '';

      const exitStrategies = Array.from(
        document.querySelectorAll('input[name="exit-strategy"]:checked')
      ).map(el => el.value);

      const buyerProfileId = buyerProfileEl.value;
      const buyerProfile = BUY_BOX_PROFILES[buyerProfileId];
      const buyerProfileName = buyerProfile ? buyerProfile.name : '';

      const comps = [];
      compBody.querySelectorAll('tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (!inputs.length) return;
        const [addr, dist, bb, csqft, price, dom, cnotes] = inputs;
        if (
          addr.value ||
          dist.value ||
          bb.value ||
          csqft.value ||
          price.value ||
          dom.value ||
          cnotes.value
        ) {
          comps.push({
            address: addr.value || '',
            distance: dist.value || '',
            bedsbaths: bb.value || '',
            sqft: csqft.value || '',
            price: price.value || '',
            dom: dom.value || '',
            notes: cnotes.value || ''
          });
        }
      });

      return {
        address,
        arv,
        asking,
        repairs,
        status,
        closeDate,
        sqft,
        bedsbaths,
        notes,
        internalNotes,
        exitStrategies,
        buyerProfileId,
        buyerProfileName,
        comps
        // photos deliberately NOT stored to keep storage small
      };
    }

    function applyPacketState(state) {
      document.getElementById('deal-address').value = state.address || '';
      document.getElementById('deal-arv').value = state.arv || '';
      document.getElementById('deal-asking').value = state.asking || '';
      document.getElementById('deal-repairs').value = state.repairs || '';
      document.getElementById('deal-status').value = state.status || 'Under Contract';
      document.getElementById('deal-close-date').value = state.closeDate || '';
      document.getElementById('deal-sqft').value = state.sqft || '';
      document.getElementById('deal-bedsbaths').value = state.bedsbaths || '';
      document.getElementById('deal-notes').value = state.notes || '';
      document.getElementById('internal-notes').value = state.internalNotes || '';

      // Exit strategies
      document
        .querySelectorAll('input[name="exit-strategy"]')
        .forEach(el => (el.checked = false));
      if (Array.isArray(state.exitStrategies)) {
        document
          .querySelectorAll('input[name="exit-strategy"]')
          .forEach(el => {
            if (state.exitStrategies.includes(el.value)) {
              el.checked = true;
            }
          });
      }

      // Buyer profile
      buyerProfileEl.value = state.buyerProfileId || '';
      const profile = BUY_BOX_PROFILES[state.buyerProfileId || ''];
      if (profile) {
        buyerProfileDescEl.textContent = `${profile.name}: ${profile.desc}`;
      } else {
        buyerProfileDescEl.textContent = 'Pick a profile to show buyers who this is perfect for.';
      }

      // Comps
      compBody.innerHTML = '';
      if (Array.isArray(state.comps) && state.comps.length) {
        state.comps.forEach(c => addCompRow(c));
      } else {
        addCompRow();
        addCompRow();
        addCompRow();
      }
      recomputeAvgPps();

      // Photos: reset (not part of template)
      photos = [];
      gallery.innerHTML = '';
    }

    savePacketBtn.addEventListener('click', () => {
      const name = packetNameEl.value.trim();
      if (!name) {
        alert('Enter a name for this packet/template first.');
        return;
      }
      const state = collectPacketState();
      const now = Date.now();
      const id = crypto.randomUUID();
      savedPackets.push({
        id,
        name,
        updatedAt: now,
        ...state
      });
      selectedPacketId = id;
      persistSavedPackets();
      renderSavedPackets();
    });

    updatePacketBtn.addEventListener('click', () => {
      if (!selectedPacketId) {
        alert('Select a saved packet to update.');
        return;
      }
      const idx = savedPackets.findIndex(p => p.id === selectedPacketId);
      if (idx === -1) {
        alert('Selected packet not found.');
        return;
      }
      const name = packetNameEl.value.trim() || savedPackets[idx].name;
      const state = collectPacketState();
      const now = Date.now();
      savedPackets[idx] = {
        ...savedPackets[idx],
        name,
        updatedAt: now,
        ...state
      };
      persistSavedPackets();
      renderSavedPackets();
    });

    loadPacketBtn.addEventListener('click', () => {
      if (!selectedPacketId) {
        alert('Select a saved packet to load.');
        return;
      }
      const packet = savedPackets.find(p => p.id === selectedPacketId);
      if (!packet) {
        alert('Selected packet not found.');
        return;
      }
      applyPacketState(packet);
    });

    deletePacketBtn.addEventListener('click', () => {
      if (!selectedPacketId) {
        alert('Select a saved packet to delete.');
        return;
      }
      if (!confirm('Delete this saved packet/template?')) return;
      savedPackets = savedPackets.filter(p => p.id !== selectedPacketId);
      selectedPacketId = null;
      persistSavedPackets();
      renderSavedPackets();
    });

    // Initialize saved packets on load
    loadSavedPackets();

    // Service Worker registration (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./sw.js')
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
